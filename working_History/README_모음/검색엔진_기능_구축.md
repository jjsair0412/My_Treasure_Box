# 검색엔진 기능 구축
elastic search를 활용하여 검색 속도 개선 및 카테고리별 검색 기능을 개발하는동안 고찰했던 정보를 기록하였습니다.

## RDB에있는 데이터를 엘라스틱서치 클러스터에 색인 시키기
spring batch를 활용해서 , RDB에 있는 검색관련 정보들을 join-select 한 다음, 생성된 entity를 사용해서 elastic search의 index 색인 작업이 첫번째 동작과정

- 고민해볼 포인트
>spring batch의 주기
>
>전체 인덱스를 주기별로 계속 붓는다면 , 붓기전에 upload된 데이터는 , batch가 돌기 전까진 검색할 수 없다는 단점이 있음. 또한 추가되거나 삭제된 정보도 볼 수 없다.
>
>따라서 부분(upload , delete) 이벤트만 실행하는 batch를 하나 더 개발해서 , 부분 batch는 전체 batch보다 짧은 주기로 동작하게끔 하는 방안을 고려중
- [elasticsearch 색인 정책에 대한 고찰](#rdb-데이터-색인-구조)

### 첫번째 결과
Spring Batch Job에서 , JPA로 RDB 데이터를 모두 Select 한 후 , 프로세싱한뒤 elasticSearch에 색인하였습니다.
>현재는 RDB의 전체 데이터를 JobSchuduler에 맞게 elasticSearch에 색인중 입니다.
- [SpringBatch_Application](../BackEnd_Spring/searchFunctionTest/allIndexInitBatch/)

또한 ElasticSearch High Level Rest API를 통해 색인된 doc 들을 검색하는 API를 개발하였습니다.
>합성어 별 검색이 가능하게끔 구현하였습니다.
- [SpringBoot_Search_Application](../BackEnd_Spring/searchFunctionTest/searchAPI/)

#### 고려해야될 사항 및 추가 개발사항
**1. 카테고리 종류**

현재는 카테고리가 1Depth만 존재하는데 , 최소 2Depth까지 들어가도록 개발해야합니다.
- 카테고리 관리 테이블이 따로있어야할듯

**2. 검색 우선순위**

현재는 Id값을 기반으로 검색 결과가 오름차순 정렬하게끔 되어 있는데, 아래 요구사항대로 정렬되어야 합니다.

- 요구사항
    - 만약 ```우주정거장``` 이라는 검색어가 검색됐다면 , 우선순위를 ```우주정거장``` 전체가 match되는 doc이 최 상단으로 추출되고 , 그 후 어미별 좌측부터 우측으로 ```우주``` 추출 , ```정거장``` 순으로 추출되어야 합니다.

## RDB 데이터 색인 구조
색인용 Spring Batch API는 아래 두가지로 가져가려 하고 있습니다.
- 아래 두가지 Batch API가 동시에 발생한다면, elasticsearch에 저장된 데이터 정합성이 맞지 않는 문제가 발생할 수 있기에, 한개가 실행될 때에는 다른 한개는 실행되면 안됩니다.
>둘의 정합성을 위해서 Redis를 사용해야 할까 ?

**1. 전체 데이터 색인**
- 

[전체 색인 Batch test code](../BackEnd_Spring/searchFunctionTest/allIndexInitBatch/)

전체 색인은 하루에 한번, 또는 특정 주기에 모든 데이터를 elasticsearch에 저장합니다.
>bulk API를 통해 진행

**2. 부분 데이터 색인**
- 

[부분 색인 Batch test code](../BackEnd_Spring/searchFunctionTest/eventIndexInitBatch/)

부분 색인은 RDB row에 특정 event (update, delete, insert) 가 되었을 경우 , 짧은 주기 (10초 등) 에 event가 발생한 row만 데이터를 elasticsearch에 색인 합니다.
>bulk API를 통해 진행

### 아키텍처
#### 동기화 기준
ElasticSearch와 동기화를 맞춰야되는 기준은 다음과 같습니다.

1. 새로운 카테고리가 등록되었을 경우
    - 관리자만 가능
2. 새로운 영상이 업로드 되었을 경우
3. 업로드된 영상의 카테고리가 변경 (추가 , 제거) 되었을 경우
4. 영상이 삭제되었을 경우

>위 이벤트가 발생했을 때 , Elastic Search에도 반영되야만 합니다.

따라서 event Table을 생성해야할것 같습니다.

- eventTable
|컬럼 명|Data Type|요약 정보|비고|
|------|---|---|--|
|_id|int|row별 Id 값|PK|
|action|varchar(20)|어떤 이벤트가 발생했는지 체크 - UPDATE && DELETE|-|
|firstIdInfo|int|카테고리들의 식별번호|FK|
|changesValue|varchar(500)|doc 별 실제변경내용|해당 칼럼으로 바로 ElasticSearch에 색인할 수 있도록 bulk 형 json으로 넣어두기|
|updateDateTime|timestemp|이벤트 발생 일자|-|

#### 고려 항목
1. 이벤트 테이블에 등록 방법
- 코드상에서 같이 해주는 방법 (insert) 과, DB 트리거등록 방법 두가지로 나뉠듯
2. 이벤트 테이블에 관리 방법
- 외부 DB를 또 생성 ?

### 이론들
#### bulk API vs 일반 색인
bulk API는 elasticsearch에서 다수(대량) 인덱스에 대해 색인, 갱신, 제거를 단일 API로 수행할 수 있게 해주는 기능 입니다.

bulk API를 사용한다면 아래와 같은 이점을 가질 수 있습니다.
- 일반 색인과 다르게 대량의 문서를 한번에 호출로 elasticSearch에 색인하기 때문에 , 속도가 훨씬 빠릅니다.
- 다수 인덱스를 색인하려고 여러번 elasticsearch를 호출하지 않기 때문에 , 네트워크 오버헤드를 최소화할 수 있습니다.
- Bulk API를 사용하여 인덱스, 업데이트, 삭제 작업을 혼합하여 실행할 수 있습니다.
