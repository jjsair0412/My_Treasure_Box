# free command와 Linux 메모리 관리 방안
free 명령어와 /proc/meminfo , slab 영역을 통해서 Linux의 메모리를 관리하는 방안을 학습한 기록 입니다.
## free command
리눅스에서 메모리 사용량을 가장 빠르고 쉽게 알 수 있는 방법은 free 명령어를 사용하는 것 입니다.

```bash
$ free -m
               total        used        free      shared  buff/cache   available
Mem:             949         125         602           2         220         683
Swap:              0           0           0
```

top 명령어와 동일하게 많은 부분을 축약해서 빠르게 파악할 수 있고 , - 옵션으로 출력 단위또한 변경이 가능함.
- ```-b : byte 단위```
- ```-m : MB 단위```
- ```-g : GB 단위```

각 부분을 뜯어보면 다음과 같음.
### Mem row
현재 시스템에 설치되어 있는 메모리의 정보
#### 1. total
시스템에 구성된 메모리의 총 양

#### 2. used
현재 시스템이 사용중인 메모리의 양

#### 3. free
시스템이 아직 사용하고 있지 않은 메모리의 양. 커널이 사용할 수 도 있고, 프로세스가 사용할 수 도 있음.

#### 4. shared 
프로세스 사이에 공유되고있는 메모리의 양

#### 5. buff/cache
버퍼 및 캐시 용도로 사용되고있는 메모리의 양. 프로세스가 사용하는것은 아니고 , I/O나 파일 읽기 등의 성능을 향상시키기 위해 커널이 사용중인 영역

#### 6. available
프로세스 또는 커널이 사용 가능한 메모리의 양

### Swap row
Swap 메모리 정보

#### 1. total
Swap 영역의 전체 용량

#### 2. used 
Swap 영역이 실제로 사용중인 양

#### 3. free
Swap 영역 중 사용하지 않은 영역의 양

## buff/cache 영역
- 위의 명령어중 , buff/cache 영역에 대해 기술

커널은 기본적으로 **1. 블록 디바이스에서 데이터를 읽거나,**  **2. 사용자의 데이터를 디스크에 저장함.** 그러나 디스크는 다른 장치에 비해 느리기에, 캐시처리하여 성능을 높힐 필요가 있었음.

***따라서 메모리의 일부를 디스크 요청에 대한 캐싱 영역으로 할당하여 사용. 한번 읽어온 내용을 메모리에 캐싱처리해두고, 동일 요청에 대해 캐시를 반환하면서 성능을 높힘.***

이때 사용되는 영역이 **buff/cache** 영역

### 커널과 블록 디바이스의 관계
위의 설명처럼 커널은 캐시 처리를 통해 성능을 높힘.

읽는 대상이 어떤것이냐에 따라 생성되는 프로세스가 달라짐.

#### 1. 파일 데이터 읽어오기
만약 커널이 읽어야할 데이터가 파일 내용이라면 커널은 bio 구조체를 생성함. 

그리고 해당 구조체는 블록 디바이스와 통신해서 데이터를 읽고 Page Cache에 캐싱 처리함.

#### 2. 파일 시스템 메타데이터 읽어오기
bio 구조체를 사용하지 않고, _get_blk() 와 같은 내부 함수를 사용.

이때 가져온 내용을 Buffer Cache에 캐싱 처리함.

***결론적으로 Page Cache는 파일 내용을 저장하고 있는 캐시 , Buffer Cache 는 파일 시스템의 메타데이터를 담고 있는 블록을 저장하고 있는 캐시이며 , 각각 cached, buffers 영역임.***

## free 명령어에서 buff/cache 영역이 중요한 이유
서버 운영기간이 길지 않을 경우, 메모리는 가용 영역과 사용 영역 두곳으로만 나누어짐.

허나 서버의 Application이 배포되어 운영 기간이 길어지면 길어질수록 메모리에 캐시된 영역이 넓어지고 가용 영역은 줄어들며 사용 영역이 늘어날것임.

***이후 사용 영역이 점점 더 커져서 일정 수준을 넘어서면, 커널은 Cache 된 영역을 Application이 사용할 수 있도록 메모리에 반환하게 됨.***

이 과정을 반복하면 더이상 반환할 영역도 없고 가용영역도 없어지는데, 이때 ***Swap*** 영역을 사용하며 **시스템 성능이 낮아지기 시작함.**

따라서 메모리 성능을 측정할 때에는 Cache된 영역이 얼마나 남았는지, 늘어나있다가 갑자기 줄어들진 않았는지 등을 파악하여 Application이 사용중인 메모리를 측정해야 함.

## /proc/meminfo
free 명령어보다 더 자세히 현재 메모리 현황을 파악할 수 있는데, ```/proc/meminfo``` 를 사용함.

```bash
$ cat /proc/meminfo 
MemTotal:         972344 kB
MemFree:          617212 kB
MemAvailable:     700244 kB
Buffers:            2168 kB
Cached:           198332 kB
SwapCached:            0 kB -- 1
Active:           115960 kB 
Inactive:         130372 kB 
Active(anon):        672 kB -- 2
Inactive(anon):    48040 kB -- 3
Active(file):     115288 kB -- 4
Inactive(file):    82332 kB -- 5
Unevictable:           0 kB
Mlocked:               0 kB
SwapTotal:             0 kB
SwapFree:              0 kB
Zswap:                 0 kB
Zswapped:              0 kB
Dirty:                 0 kB -- 6
...
```

주요 부분들이 존재하는데, 각각에 대해 설명함

### 1. SwapCached
swap 영역으로 빠진 메모리 영역 중 , 다시 메모리로 돌아온 영역을 뜻함.

시스템에 메모리가 부족하면 커널은 프로세스 주소 공간 중 swap 영역으로 이동 가능한 메모리 영역을 선택하여 swap으로 옮김.

이 과정에서 I/O 가 발생하기에 성능 저하가 발생함.

그리고 메모리가 확보되면, swap으로 빠졋던 영역이 다시 메모리로 반환되는데, 그래도 커널은 swap 영역에서 해당 메모리 내용을 제거하지 않음.
- 이는 다시 메모리부족이 일어날 것을 대비함에 있음. 다시 영역이 필요하면 재할당이 아닌 재활용하기 때문. (I/O를 줄이기 위해)

### 2. Active(anon)
Page Cache 영역을 제외한 메모리 영역. 주로 프로세스들이 사용하는 메모리 영역을 나타낼 때 사용

### 3. Inactive(anon)
Active(anon) 과 같이 영역을 의미하는데, ***참조된지 오래되어 Swap 영역으로 이동될 수 있는 메모리 영역을 의미함.***

### 4. Active(file)
커널이 I/O 성능 향상을 위해 캐시로 사용하는 영역. buff/cache 영역이 여기에 속함.

### 5. Inactive(file)
커널이 캐시 목적으로 사용하고 있는 영역. ***참조된지 오래되서 Swap으로 이동될 수 있는 메모리 영역***

### 6. Dirty
캐시 목적으로 사용하는 영역 중 , ***쓰기 작업이 이루어져서 실제 블록 디바이스의 블록에 씌여져야 하는 영역을 의미함.***

커널은 블록 디바이스에 쓰기를 계속해서 수행하는것이 아니라, 모아놧다가 한번에 쓰기때문에 여기에 저장됨.

## slab 영역
커널또한 프로세스기 때문에 메모리를 할당받아서 사용해야 함.

커널은 일반적인 방법으로 할당받아 사용하진 않고, /proc/meminfo 내용 중 slab 영역으로 커널은 메모리를 사용함.

```bash
$ cat /proc/meminfo 
...
Slab:              56772 kB -- 1
SReclaimable:      25892 kB -- 2
SUnreclaim:        30880 kB -- 3
...
```

### 1. Slab
메모리 영역 중 커널이 직접 사용하고있는 영역

### 2. SReclaimable
Slab 영역 중 재사용이 가능한 영역. 캐시 용도로 사용되는 메모리들이 여기 포함됨.

### 3. SUnreclaim
Slab 영역 중 재사용될 수 없는 영역

---
### slabtop command
slabtop 명령어로 slab 정보를 파악할 수 있음.

```bash
$ sudo slabtop -o
 Active / Total Objects (% used)    : 379927 / 382367 (99.4%)
 Active / Total Slabs (% used)      : 6810 / 6810 (100.0%)
 Active / Total Caches (% used)     : 117 / 171 (68.4%)
 Active / Total Size (% used)       : 50809.55K / 51725.90K (98.2%)
 Minimum / Average / Maximum Object : 0.01K / 0.13K / 10.12K

  OBJS ACTIVE  USE OBJ SIZE  SLABS OBJ/SLAB CACHE SIZE NAME                   
108800 108800 100%    0.02K    640      170      2560K avtab_node             
 72512  72512 100%    0.06K   1133       64      4532K vmap_area           
...
```

### slab 용도
프로세스는 작업하기 위해 메모리가 필요함. 커널도 예외는 아닌데, 커널은 I/O 작업성능을 높히는 등의 작업을 수행하기에 메모리를 할당받아야 함.

이때 메모리를 효율적으로 할당받기 위해 따로 slab 영역을 사용하게 됨.

**slab 영역은 free 명령어 결과에서 used로 계산되기에, 프로세스들이 사용하는 영역을 모두 더했는데도 used와 맞지 않다면, slab 메모리에서 누수가 발생하는것일 확률이 있음.**