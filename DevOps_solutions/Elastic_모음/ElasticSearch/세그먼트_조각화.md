
# 세그먼트 조각화
Elasticsearch에서는 데이터를 Lucene 기반의 인덱스 형태로 저장합니다. 이 인덱스는 여러 세그먼트로 나뉘며, 각 세그먼트는 독립적으로 검색할 수 있는 작은 인덱스 단위입니다.

## ***세그먼트(Segment)란?***

      Elasticsearch의 각 문서는 내부적으로 Lucene 기반의 인덱스에 저장됩니다.

      Lucene 인덱스는 다수의 세그먼트로 구성되며, 각 세그먼트는 독립적인 인덱스로 간주될 수 있습니다.

      데이터가 추가/수정될 때마다 새로운 세그먼트가 생성될 수 있습니다.

      이러한 세그먼트들은 시간이 지남에 따라 병합될 수도 있습니다.

## ***세그먼트 조각화(Segment Fragmentation)란?***

    시간이 지나면서 데이터의 추가, 수정, 삭제 작업이 반복되면 많은 수의 작은 세그먼트들이 생성될 수 있습니다.

    이렇게 많은 수의 작은 세그먼트들이 존재하면 검색 성능에 부정적인 영향을 줄 수 있습니다.

    이를 세그먼트 조각화라고 합니다.

### 왜 문제가 되는가?

    검색을 수행할 때 각 세그먼트를 개별적으로 검색해야 하므로 세그먼트의 수가 많을수록 검색 성능에 부담이 될 수 있습니다.

    또한, 많은 수의 작은 세그먼트들은 디스크 공간을 비효율적으로 사용하게 만들 수 있습니다.

### 해결책은?

    Elasticsearch는 세그먼트 병합(segment merge)이라는 프로세스를 통해 주기적으로 작은 세그먼트들을 큰 세그먼트로 합치는 작업을 수행합니다. 

    이렇게 하면 세그먼트의 수가 줄어들고, 디스크 공간 사용도 효율적으로 되며, 검색 성능도 개선될 수 있습니다.

    또한, Elasticsearch에서는 force merge라는 API를 제공하여, 사용자가 수동으로 세그먼트 병합을 요청할 수도 있습니다. 그러나 force merge는 I/O 작업이 많이 발생하므로 클러스터에 부담을 주게 될 수 있으므로 주의하여 사용해야 합니다.

### 결론 

    요약하면, 세그먼트 조각화는 Elasticsearch의 세그먼트 구조와 관련된 현상으로, 이로 인해 검색 성능에 부정적인 영향을 받을 수 있습니다. 따라서 적절한 인덱스 관리 및 세그먼트 병합 전략을 통해 성능을 최적화하는 것이 중요합니다.

### 나의 해결책은 ?
RDB상 변동된 부분만 색인하는 SpringBatch와 , 전체 정보를 조회하여 색인하는 SpringBatch로 분리시켜서 세그먼트 조각화를 방지하였습니다.
>전체 정보를 색인하며 ElasticSearch의 데이터를 flush함으로써 여러 작은 세그먼트들을 병합시켜 세그먼트 조각화 방지




