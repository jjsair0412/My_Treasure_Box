# Basic_Elastic
## Overview
해당 문서는 ElasticSearch의 전반적인 특징에 대해 기술합니다.

## 문서 색인
- [ElasticSearch_란?](#elasticsearch-란)
    - ElasticSearch 란 무엇인가?
- [ElasticSearch_기초_동작방식](#elasticsearch-클러스터와-노드)
    - ElasticSearch 의 노드 종류 및 동작방식에 대해 기술
- [ElasticSearch의_인덱스_와_샤드](#elasticsearch-인덱스index-와-샤드)
    - ElasticSearch 의 인덱스와 샤드에 대해 기술
- [Index_템플릿](#3-인덱스-템플릿)
    - ElasticSearch 의 Index 템플릿에 대해 기술 (미리 샤드 정해놓기)
- [ElasticSearch_매핑_이란](#매핑mapping-이란)
    - ElasticSearch 의 동적 매핑 및 정적 매핑 에 대해 기술,

## ElasticSearch 란 ?
루씬 (Lucene) 기반의 오픈소스 검색 엔진입니다.
- 루씬 : java 라이브러리

json 기반의 문서를 저장 검색할 수 있으며 , 분석 작업또한 가능합니다.

### ElasticSearch 특징
**1. 준 실시간 검색 시스템**

실시간인것처럼 , 색인된 데이터가 빠르게 검색될 수 있습니다.

**2. 고 가용성을 위해 클러스터 구성**

한대 이상의 노드로 클러스터를 구성하여 , 높은 수준의 안정성을 달성하고 부하분산또한 가능합니다.

한대 이상이기에 , 한대로도 구성이 가능합니다.

**3. 동적 스키마 생성**

입력될 데이터들에 대해 미리 스키마를 정의하지 않더라도 , 동적으로 스키마 생성이 가능합니다.

**4. Rest API 기반의 인터페이스**

Rest API를 제공하기에 사용을 위한 진입장벽이 낮습니다.

## ElasticSearch 클러스터와 노드
ElasticSearch는 **여러대 노드**들이 **각자 역할을 바탕**으로 연결되어 **하나의 시스템처럼 동작**하게 되어 있습니다.
- 클러스터링 가능

클러스터 **성능이 저하되면 , 노드를 늘려서 대응이 가능**합니다.
- 노드가 늘어난다고 해서 성능이 늘어나는것은 아닙니다.

### Elastic Node 의 종류
|||
|--|--|
|**종류**|**역할**|
|마스터 노드|클러스터 상태 관리 및 메타데이터 관리|
|데이터 노드|문서 색인 및 검색 요청 처리|
|코디네이팅 노드|검색 요청 처리|
|인제스트 노드|색인되는 문서의 ***데이터 전처리***|

인제스트 노드에서 , 데이터를 전처리한다는 의미는 어떤 데이터가 ES 내부로 저장되기 전에 , 문서를 수정한다는 의미 입니다.
- 저장전 특정 필드값을 수정하고 저장함

ES의 마스터 노드는 , 마스터 노드와 마스터 후보 노드로 나뉩니다.
- ***마스터 노드***는 지금 ES 클러스터에서 마스터 노드의 역할을 함
- ***마스터 후보 노드***는 마스터 노드가 문제가 생겼을 때 , 마스터 노드가 될 수 있는 노드를 의미

**ES는 클러스터링 되어 있기에 어떤 노드에 어떤 요청을 보내도 동일한 응답이 오게 됩니다.**
- 따라서 , 각 노드들이 본연의 역할에 충실할 수 있도록 구성해야만 합니다.
- Elastic 클러스터링을 한 뒤 , 특정 노드에 직접 접근하게끔 구성하는게 아니라 , 앞단에 LB Endpoint를 두는것이 유연한 구성입니다.

## ElasticSearch 인덱스(index) 와 샤드
- ElasticSearch의 계념을 익히기 위해 ES 와 RDBMS 를 비교합니다.

|||
|--|--|
|**ElasticSearch**|**RDBMS**|
|index|database|
|mapping|schema|
|document|row|

### 1. 인덱스 (index) 란?
문서가 저장되는 논리적 공간입니다.

문서를 저장하기 위해선 **반드시 인덱스가 존재해야만 합니다.**

**인덱스를 설계하는것이 , ES를 사용하기 위해 고려해야하는 첫 단계 입니다.**
- 인덱스 설계에 따라 문서의 구조 및 검색 쿼리가 달라집니다.

#### 인덱스 설계 방안
- 인덱스를 설계할 땐 , 처음엔 단순하게 설계하고 나중에 사용 패턴에 따라 인덱스를 별도로 운영해야 합니다.

||||
|--|--|--|
|케이스|장점|단점|
|인덱스를 하나만 사용|관리할 인덱스 수가 적기에 관리 리소스가 적게 발생|쿼리와 문서의 구조가 복잡해진다.|
|인덱스를 여러개로 나누기|각각의 경우에 최적화된 쿼리와 문서 구조를 사용할 수 있음|관리해야할 인덱스 수가 많아 관리 리소스가 발생할 수 있음|

### 2. 샤드 (shard) 란? 
인덱스에 색인되는 문서가 저장되는 공간입니다.

**하나의 인덱스는 반드시 하나의 샤드를 가집니다.**

#### 샤드의 종류
|||
|--|--|
|종류|역할|
|프라이머리 샤드|문서가 저장되는 원본 샤드 , 색인과 검색 성능에 모두 영향을 미칩니다.|
|레플리카 샤드|프라이머리 샤드의 복제 샤드 , 검색 성능에 영향을 줍니다. 프라이머리 샤드에 문제가 발생하면 , 레플리카 샤드가 프라이머리 샤드로 승격됩니다.|

#### 샤드 설정방안
PUT 요청을 통해 샤드 개수를 지정할 수 있습니다.
- 아래처럼 요청보내면 , 프라이머리 샤드 5개 , 레플리카 샤드는 10개 입니다.
- replica shards 개수 = (number_of_shards * number_of_replicas)
```bash
PUT /library/_settings
{
    "index": {
        "number_of_shards" : 5, 
        "number_of_replicas" : 2
    }
}
```

#### 샤드 라우팅 -> 중요
문서가 샤드에 저장되는 순서 ?

![shard][shard]

[shard]:./images/shard.png

문서들은 기본적으로 0~2 순서로 고르게 라운드로빈형식으로 저장됩니다.

그래서 만약 샤드의 갯수가 바뀌면, 문서가 저장되는 규칙은 완전히 바뀌게 됩니다.
- **Routing Rule = (문서의 ID) % (샤드의 개수)**
    - % : 모듈러 연산

따라서 , 인덱스를 생성할 때 프라이머리 샤드의 개수를 설정하는 것은 매우 중요합니다.
- Routing Rule은 문서 ID % 샤드개수 (모듈러 연산) 기 때문에 바꿀수 없기 때문

number_of_shards의 default는 1
- 하지만 default를 사용한다면 성능에 큰 영향을 미칩니다.


### 3. 인덱스 템플릿
ES 에서는 인덱스를 생성할 때 샤드도 미리 만들어주어야 하는것은 아닙니다.

템플릿이 있기 때문.

인덱스 템플릿을 아래처럼 생성해두면 nginx-logs-로 시작하는 모든 인덱스는 프라이머리 샤드 3개 , 레플리카 샤드 6개로 생성됩니다.
- (ex. nginx-logs-2023.06.29 , nginx-logs-2023.06.30 )
```bash
PUT _index_template/base_template

{
    "index_patterns": ["nginx-logs-*"],
    "template": {
        "settings":{
            "number_of_shards": 3,
            "number_of_replicas": 2
        }
    }
}
```

## 매핑(mapping) 이란 ?
문서의 구조를 나타내는 정보

ES는 스키마리스가 아니라 , 미리 정의하지 않아도 될 뿐입니다.

### 1. 매핑의 종류
|||
|--|--|
|종류|정의|
|동적 매핑 (Dynamic Mapping)|처음 색인되는 문서를 바탕으로 , 매핑 정보를 ElasticSearch가 동적 생성|
|정적 매핑 (Static Mapping)|문서의 매핑 정보를 미리 정의|

동적이던 정적이던 , 매핑정보가 생성된 이후엔 type이 맞지 않으면 typemissmatch 에러가 발생합니다.

#### ***동적 매핑***
어떤 문서가 색인될지 스키마를 미리 정의하지 않아도 됨.

#### ***정적 매핑***
어떤 문서가 색인될지 스키마를 미리 정의합니다.

모든 필드를 정적매핑일 필요는 없습니다.

어떤 타입만 정적 매핑을 하고 , 정적매핑을 안한곳에선 동적 매핑으로 자동 색인됩니다.

정적 매핑은 문서의 필드들이 갖는 값에 따라 타입을 지정해줄 필요가 있을 때 사용합니다.
- [ES_공식문서_TYPE](https://www.elastic.co/guide/en/elasticsearch/reference/current/number.html)

불필요한 색인이 발생하지 않게 하기 위해 사용합니다.