# Study information
## pod external open
### 1. 웹 브라우저로 Pod 연결 vs curl로 pod 연결
웹 브라우저로 ingress나 nodeport로 열린 pod에 연결하면 , 계속 같은 pod가 응답합니다.
그러나 curl은 매번 새로운 pod에 연결하는데 , 그러한 이유는 다음과 같습니다.

브라우저는 keep-alive 연결을 사용하기에 같은 연결로 모든 요청을 보내는 반면 , curl은 매번 새로운 연결을 엽니다.
서비스는 연결 수준에서 동작하기에 서비스에 대한 연결을 여는 순간 임의의 pod가 선택되고 , 해당 pod가 계속 요청에 응답하는것입니다.

세션 어피니티가 none일 경우에도 세션이 종료될 때 까지 사용자는 항상 동일한 pod에 연결됩니다.
### 2. nodeport vs loadbalancer
service의 LoadBalancer type은 nodeport를 확장한 계념이기 때문에 , LB가 프로비저닝되지 않은 환경에서도 열린 포트번호로 접근할 수 있습니다.
### 3. 외부 연결의 특성 ( NodePort 일 경우 )
#### 3.1 불필요한 네트워크 홉 ( hop ) 의 예방
만약 nodeport로 외부 클라이언트가 서비스에 접근할 경우 , 임의로 선택된 파드가 연결을 수신한 노드에 실행중일 수 도 있고 , 아닐 수도 있습니다.

만약 아니라면 , 다른 노드로 이동하는  1홉 ( hop ) 이 추가되는데 , 이게 속도를 저하시킬 수 있습니다.
```
ex ) 
노드 A : 10.0.0.1:30001
노드 B : 10.0.0.2:30001
만약 파드가 노드 A에만 떠잇는 상태에서 , 노드 B로 요청을 보내면 노드 A로 1홉을 더 가야한다.
```
추가 홉을 방지하는 임시 방편은 , 외부 연결을 수신받은 노드에서 실행중인 파드로만 외부 트래픽을 전달하도록 서비스를 구성해서 방지할 수 있습니다.
service의 spec 섹션에 externalTrafficPolicy를 추가하면 됩니다.
```
spec:
  externalTrafficPolicy: Local
```

위와같이 서비스가 설정되어 있고 , nodeport로 열려있다면 아래 두 case가 있다.
1. 노드에 파드가 생성되어 있을 경우
파드가 생성되어 있다면 , 서비스 프록시는 로컬에 실행 중인 파드를 선택한다.
2. 노드에 파드가 생성되어 있지 않은 경우
nodeport로 열려있다면 파드가 안떠있는 노드에 요청을 보낼시 연결이 중단 됩니다.

[관련 공식문서](https://kubernetes.io/docs/tasks/access-application-cluster/create-external-load-balancer/#preserving-the-client-source-ip)

단점 
- LB를 앞단에 붙이면 , 파드에 트래픽이 균등하게 부하분산되지만 , 해당 설정을 붙이면 균등하게 트래픽이 분산되지 않습니다.
당연히 잇는곳에만 뿌리기에 균등하지 않습니다.

#### 3.2 클라이언트 ip가 보존되지 않음 인식
노드포트로 연결을 수신하면 패킷에서 소스 네트워크 주소 변환 ( SNAT ) 가 수행되기에 패킷 소스 IP가 변경됩니다.

**그에 따라 파드는 실제 클라이언트의 IP를 볼 수 없습니다 !!! **

해당 이슈는 어플리케이션 특성에 따라 치명적일 수 있습니다.

예를들어 웹 서버의 경우 , 액세스로그에 브라우저 IP를 표시하지 못합니다.

