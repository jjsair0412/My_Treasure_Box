# Longhorn 씬 프로비저닝과 볼륨 크기
## Overview
Longhorn은 씬 프로비저닝(Thin Provisioning) 관리 기법을 사용. **실제로 사용 중인 데이터만큼만 물리적 스토리지를 할당함.**

## 1. 씬 프로비저닝(Thin Provisioning) 기법이란?
만약 20GB 볼륨을 생성하고, 실제 데이터는 1GB만 저장했을 경우 **물리적으로는 1GB만 사용됨.**

**전체 20GB를 할당하지 않고, 필요할 때마다 공간을 할당하는 방식**

### 1.2 장점
1. 스토리지 효율성 향상

    실제 사용하는 용량만큼만 할당하기 때문에, **스토리지 용량을 효율적으로 분할하여 사용이 가능**

    ***20GB 용량인 볼륨을 10개 있을 경우에, 만약 실제 데이터는 각각 5GB만 사용한다면, 기존에는 200GB가 필요했지만 씬 프로비저닝 방식은 50GB만 있으면 됨.***

2. 오버프로비저닝 가능

    실제 물리적 용량보다 더 많은 스토리지를 가상으로 할당하는 것이 가능함.

    **물리적으로 1TB짜리 볼륨 있을 경우, 500GB짜리 3개를 생성하는게 가능.(모두 차지 않았다는 가정 하에)**

3. 초기 비용 절감

    필요한 볼륨만큼만 할당하기 때문에, 초기 하드웨어 비용을 줄일 수 있으며, 필요에따라 확장이 유연함.

4. K8s 환경과의 통합

    PVC를 통해 개발자가 스토리지 용량 걱정 없이 할당이 가능함.

    실제 사용량만 차지하기 때문에, 개발자들이 넉넉하게 용량을 생성해도 스토리지 리소스 낭비 최소화.

## 2. Longhorn에서의 씬 프로비저닝 방식
Longhorn은 [씬 프로비저닝 기법](#1-씬-프로비저닝thin-provisioning-기법이란)을 사용한 분산 블록스토리지 시스템임. 

따라서 20GB 볼륨 생성 이후 1GB만 데이터 저장한 경우, 물리적으로는 1GB만 사용됨.

이는 K8s 환경에서 알맞는 선택이며, 초기 비용을 절감할 수 있고 스토리지 효율성을 향상시킴.

## 3. Block Storage System에서의 공간 회수 제한 -> 중요
Longhorn과 같은 Bloack Storage System은 **한번 사용된 공간은 데이터 삭제 시에도 자동으로 회수되지 않음.**
예를들어 20GB 볼륨에서 10GB 채운 후, 9GB를 제거하더라도 실제 사용 용량은 10GB로 유지됨.

**이는 Block Storage System에서의 제약사항임.**

Bloak System 수준과 File System 계층의 동작 방식을 이해하면, 이러한 현상의 원인을 파악할 수 있음.

### 3.0 Storage 계층 구조
1. 블록 스토리지 계층 (가장 하위):

    원시 데이터 블록을 관리합니다 (예: 4KB 크기의 데이터 청크)
    블록에 번호를 부여하고 읽기/쓰기 작업을 처리합니다
    블록의 내용이나 용도에 대한 이해가 없습니다 - 그저 "블록 #1234에 이 데이터를 저장해"라는 명령만 수행
    **Longhorn은 이 계층에서 작동합니다**


2. 파일 시스템 계층 (상위):
    
    블록들을 논리적 단위인 "파일"로 구성합니다
    파일 이름, 메타데이터, 디렉토리 구조를 관리합니다
    어떤 블록이 어떤 파일에 속하는지 추적합니다
    파일이 삭제되면, 해당 블록들을 "사용 가능" 상태로 표시하지만 실제로 지우지는 않습니다

### 3.1 Block System 수준과 File System 수준의 동작 방식
Longhorn은 데이터를 Block 단위로 저장함. 데이터가 쓰이면, 해당 블록은 "사용중" 이라고 표시됨.

File System 수준에서는, 파일을 삭제한다면 즉시 해당 블록을 "사용 가능" 으로 표시함.

**그러나 Block Storage 계층인 Longhorn은 이를 알지 못하기 때문에,, 실제 데이터는 여전히 Block에 남아있으며 File System의 인덱스만 제거됨.**

### 3.2 실제 예시
- 20GB 볼륨에 10GB 데이터를 작성하면 Longhorn은 10GB 물리적 공간 할당
- 그 중 9GB의 파일을 삭제해도, 파일 시스템은 이 블록들을 "자유롭게 사용 가능"으로 표시
- 하지만 Longhorn은 어떤 블록이 실제로 필요 없는지 알 수 없어 여전히 10GB 할당 상태 유지
- 새 데이터가 쓰일 때는 파일 시스템이 "자유롭게 사용 가능"으로 표시된 블록을 재사용

### 3.3 파일 제거 시 발생하는 일
1. 사용자가 파일을 삭제합니다
2. 파일 시스템은 자신의 인덱스/테이블에서 해당 파일의 항목을 제거합니다
3. 파일이 사용하던 블록들은 "사용 가능" 상태로 표시됩니다
4. 하지만 블록 스토리지(Longhorn)는 이 정보를 받지 못합니다 - 그저 여전히 데이터가 있는 블록들을 관리할 뿐입니다
5. 실제 데이터는 새로운 데이터로 덮어쓰일 때까지 블록에 남아 있습니다

## 4. 유의 사항
Longhorn의 [공간 회수 제한](#3-block-storage-system에서의-공간-회수-제한---중요)과 [씬 프로비저닝](#1-씬-프로비저닝thin-provisioning-기법이란) 기법으로 인해 다음 사항을 유의하여 Longhorn architecture를 구성해야 함.

1. 스토리지 계획:

    볼륨 크기를 처음부터 신중하게 계획해야 합니다
    한번 사용된 공간은 다시 회수되지 않으므로, 과도하게 크게 설정하면 낭비가 발생할 수 있습니다


2. 공간 회수 방법:

    데이터를 진정으로 회수하려면, 새 볼륨 생성 후 필요한 데이터만 복사하는 방법을 사용해야 합니다
    볼륨 스냅샷 및 복원 기능을 활용하여 데이터 압축/최적화 가능


3. 모니터링 중요성:

    실제 사용량과 할당량을 지속적으로 모니터링하는 것이 중요합니다
    사용량이 급증하는 워크로드에 주의해야 합니다